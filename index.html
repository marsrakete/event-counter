<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Counter</title>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#9aa4ad; --text:#eef2f6;
      --primary:#4f8cc9; --primary-2:#2a5c8f; --accent:#607d8b; --accent-2:#455a64;
      --warn:#d32f2f; --ok:#2e7d32; --border:#222935;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
          background:linear-gradient(180deg,#0d1014,#0f1115 30%); color:var(--text); padding:1rem; }
    h1{ text-align:center; margin:0 0 1rem; font-weight:700; letter-spacing:.2px; }
    .topbar{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-bottom:1rem; }
    button{ appearance:none; border:1px solid var(--border);
            background:linear-gradient(180deg,#1c222c,#161b23); color:var(--text);
            padding:.6rem .9rem; border-radius:.65rem; cursor:pointer;
            transition:transform .08s ease, filter .15s ease, background .2s ease;
            box-shadow: 0 1px 0 rgba(255,255,255,.04) inset, 0 8px 20px rgba(0,0,0,.25); }
    button:hover{ filter:brightness(1.1) } button:active{ transform:translateY(1px) scale(.99) }
    .btn-primary{ background: linear-gradient(180deg,var(--primary),var(--primary-2)); border-color:transparent; }
    .btn-danger{ background: linear-gradient(180deg,#ef5350,#d32f2f); border-color:transparent; }
    .btn-ghost{ background: transparent; border-color: var(--border); color: var(--muted); }
    input[type="text"]{ width:100%; padding:.6rem .7rem; background:#0f141a; color:var(--text);
                        border:1px solid var(--border); border-radius:.6rem; outline:none; }
    .event{ background:var(--card); border:1px solid var(--border); border-radius:1rem;
            padding:1rem; margin:0 auto 1rem; max-width:920px; box-shadow:0 10px 25px rgba(0,0,0,.25); }
    .event-header{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .entry-row{ display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:center; margin-top:.5rem; }
    .section{ margin-top:.75rem; border-top:1px dashed var(--border); padding-top:.75rem; }
    .count-buttons{ display:flex; flex-wrap:wrap; gap:.5rem; }
    .count-buttons button{ flex:1 1 180px; background: linear-gradient(180deg,var(--accent),var(--accent-2));
                           border-color: transparent; font-weight:700; letter-spacing:.2px; }
    .badge{ display:inline-block; min-width:1.25rem; padding:.05rem .4rem; border-radius:999px;
            background:#c62828; color:#fff; font-size:.8rem; text-align:center; margin-left:.4rem; }
    .trash{ display:none; margin:1rem auto 0; max-width:920px; background:var(--card);
            border:1px solid var(--border); border-radius:1rem; padding:1rem; }
    .trash h2{ margin:0 0 .5rem } .trash-list > div{ border:1px dashed var(--border);
            border-radius:.6rem; padding:.6rem; margin:.4rem 0; }
    small.muted{ color:var(--muted) }
  </style>
</head>
<body>
  <h1>Event Counter</h1>

  <div class="topbar">
    <button class="btn-primary" onclick="createNewEvent()">+ Neues Event</button>
    <button class="btn" onclick="toggleTrash()">🗑️ Papierkorb <span id="trash-count" class="badge">0</span></button>
    <button class="btn" onclick="exportEvents()">📤 Exportieren</button>
    <input type="file" id="importFile" accept=".json,application/json" style="display:none" onchange="handleImport(event)">
    <button class="btn" onclick="document.getElementById('importFile').click()">📥 Importieren</button>
    <button class="btn-ghost" onclick="toggleHelp()">❓ Anleitung</button>
  </div>

  <div id="helpOverlay" style="display:none; position:fixed; inset:0; background:#000a; color:white; z-index:50; overflow-y:auto; padding:2rem;">
    <div style="background:#1a212b; border:1px solid #2a3443; border-radius:1rem; padding:2rem; max-width:900px; margin:auto; box-shadow:0 30px 80px rgba(0,0,0,.45)">
      <h2 style="margin-top:0">Anleitung</h2>
      <ul>
        <li><strong>+ Neues Event</strong> anlegen und benennen.</li>
        <li>Mit <strong>+ Eintrag</strong> beliebig viele Zähler hinzufügen.</li>
        <li>Unter <strong>Zählen</strong> klickst du auf die großen Buttons, um die Werte zu erhöhen.</li>
        <li><strong>Teilen</strong> öffnet die Geräte‑Teilen‑Funktion oder eine E‑Mail (<em>Betreff: Ergebnis der Zählung</em>).</li>
        <li><strong>Exportieren / Importieren</strong> sichern bzw. laden deine Events (mit XSS‑Schutz).</li>
        <li><strong>Papierkorb</strong> zeigt gelöschte Events/Einträge – von dort kannst du wiederherstellen.</li>
      </ul>
      <div style="text-align:center; margin-top:1rem">
        <button class="btn" onclick="toggleHelp()">Schließen</button>
      </div>
    </div>
  </div>

  <div id="events"></div>

  <div id="trash" class="trash">
    <h2>Papierkorb <small class="muted">(nicht persistent)</small></h2>
    <div id="trash-events" class="trash-list"></div>
    <div id="trash-entries" class="trash-list"></div>
    <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem">
      <button class="btn-danger" onclick="emptyTrash()">Papierkorb leeren</button>
      <button class="btn" onclick="toggleTrash()">Schließen</button>
    </div>
  </div>

<script>
// ====== State ======
let events = JSON.parse(localStorage.getItem("events") || "[]");
const eventsDiv = document.getElementById("events");
let trash = { events: [], entries: [] };

// ====== Helpers ======
function toggleHelp(){
  const o = document.getElementById('helpOverlay');
  o.style.display = (o.style.display==='none'||!o.style.display) ? 'block' : 'none';
}

function save(){
  localStorage.setItem("events", JSON.stringify(events));
  render();
}

function exportEvents(){
  const data = JSON.stringify(events, null, 2);
  const blob = new Blob([data], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'events-export.json'; a.click();
  URL.revokeObjectURL(url);
}

function handleImport(e){
  const file = e.target.files[0];
  if (!file || !/\.json$/i.test(file.name)) { alert("Nur JSON-Dateien importieren."); return; }
  const reader = new FileReader();
  reader.onload = () => {
    try{
      // FIX: valid regex (no invalid flags)
      const sanitized = String(reader.result)
        .replace(/<script[\s\S]*?<\/script>/gi, '')  // will be interpreted as <\/script> by parser; ensure single backslash
        .replace(/on\w+\s*=\s*(['"]).*?\1/gi, '')
        .replace(/javascript:/gi, '');
      const imported = JSON.parse(sanitized);
      if (!Array.isArray(imported)) throw new Error("Erwarte ein Array von Events.");
      let changed = false;
      imported.forEach(ne => {
        if (!ne || typeof ne !== 'object') return;
        if (!ne.id) ne.id = crypto.randomUUID();
        ne.name = String(ne.name||'Ohne Titel').replace(/[<>]/g,'');
        ne.entries = Array.isArray(ne.entries) ? ne.entries : [];
        ne.entries = ne.entries.map(en => ({
          id: en && en.id ? en.id : crypto.randomUUID(),
          label: String(en && en.label || 'Eintrag').replace(/[<>]/g,''),
          count: Number(en && en.count || 0)
        }));
        const i = events.findIndex(e => e.id === ne.id);
        if (i >= 0){
          if (confirm(`Event '${ne.name}' existiert bereits. Überschreiben?`)){
            events[i] = ne; changed = true;
          }
        } else { events.push(ne); changed = true; }
      });
      if (changed) save(); else alert("Keine Änderungen importiert.");
    }catch(err){ alert("Fehler beim Import: " + err.message); }
  };
  reader.readAsText(file);
}

function createNewEvent(){
  const name = prompt("Event-Name?") || "Neues Event";
  events.push({
    id: crypto.randomUUID(),
    name,
    status: 'new',
    entries: [
      { id: crypto.randomUUID(), label:"Mann", count:0 },
      { id: crypto.randomUUID(), label:"Frau", count:0 }
    ]
  });
  save();
}

function addEntry(ev){
  ev.entries.push({ id: crypto.randomUUID(), label:"Neuer Eintrag", count:0 });
  save();
}

function shareEvent(ev){
  const txt = `${ev.name}\n\n` + ev.entries.map(e => `${e.label}: ${e.count}`).join('\n');
  const mailto = `mailto:?subject=${encodeURIComponent('Ergebnis der Zählung')}&body=${encodeURIComponent(txt)}`;
  if (navigator.share){
    navigator.share({ title:'Ergebnis der Zählung', text:txt }).catch(()=>window.open(mailto, '_blank'));
  } else {
    window.open(mailto, '_blank');
  }
}

// ====== Render ======
function render(){
  eventsDiv.innerHTML = "";
  events.forEach((event, idx) => {
    const card = document.createElement('div');
    card.className = 'event';

    
// Header
const header = document.createElement('div');
header.className = 'event-header';

const nameInput = document.createElement('input');
nameInput.value = event.name;
nameInput.placeholder = "Event-Name";
nameInput.disabled = event.status === 'terminated';
nameInput.onchange = e=>{ event.name = e.target.value; save(); };
header.appendChild(nameInput);

// State controls
const controls = document.createElement('div');
controls.style.display = 'flex';
controls.style.gap = '.5rem';
controls.style.flexWrap = 'wrap';

if (event.status === 'new') {
  const startBtn = document.createElement('button');
  startBtn.className = 'btn-primary';
  startBtn.textContent = 'Starten';
  startBtn.onclick = () => { event.status = 'running'; save(); };
  controls.appendChild(startBtn);
} else if (event.status === 'running') {
  const stopBtn = document.createElement('button');
  stopBtn.className = 'btn';
  stopBtn.textContent = 'Event stoppen';
  stopBtn.onclick = () => { event.status = 'stopped'; save(); };
  controls.appendChild(stopBtn);
} else if (event.status === 'stopped') {
  const resumeBtn = document.createElement('button');
  resumeBtn.className = 'btn-primary';
  resumeBtn.textContent = 'Event fortsetzen';
  resumeBtn.onclick = () => { event.status = 'running'; save(); };
  controls.appendChild(resumeBtn);
}

if (event.status !== 'terminated') {
  const termBtn = document.createElement('button');
  termBtn.className = 'btn-danger';
  termBtn.textContent = 'Event terminieren';
  termBtn.onclick = () => {
    if (confirm('Event wirklich terminieren? Dies kann nicht rückgängig gemacht werden.')) {
      event.status = 'terminated';
      save();
    }
  };
  controls.appendChild(termBtn);
}

if (event.status === 'terminated') {
  const shareBtn = document.createElement('button');
  shareBtn.className = 'btn';
  shareBtn.textContent = "Teilen";
  shareBtn.onclick = () => shareEvent(event);
  controls.appendChild(shareBtn);
}

// Event löschen (Papierkorb)
const delEventBtn = document.createElement('button');
delEventBtn.className = 'btn-ghost';
delEventBtn.textContent = "Event löschen";
delEventBtn.onclick = () => {
  if (confirm("Event in den Papierkorb verschieben?")){
    trash.events.push({ ...event, deletedAt: Date.now() });
    events.splice(idx,1); save(); renderTrash(); updateTrashCount();
  }
};
controls.appendChild(delEventBtn);

header.appendChild(controls);
card.appendChild(header);

    // Entries editor
    event.entries.forEach(entry => {
      const row = document.createElement('div');
      row.className = 'entry-row';

      const label = document.createElement('input');
      label.value = entry.label;
      label.onchange = e=>{ entry.label = e.target.value; save(); };
      label.disabled = event.status === 'terminated';
      row.appendChild(label);

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-ghost';
      delBtn.textContent = "Löschen";
      delBtn.onclick = () => {
        if (confirm("Eintrag wirklich löschen?")){
          trash.entries.push({ id: entry.id, label: entry.label, count: entry.count, parentId: event.id, parentName: event.name, deletedAt: Date.now() });
          event.entries = event.entries.filter(e => e.id !== entry.id);
          save(); renderTrash(); updateTrashCount();
        }
      };
      row.appendChild(delBtn);

      card.appendChild(row);
    });

    // Add entry button
    const addRow = document.createElement('div');
    addRow.className = 'section';
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-primary';
    addBtn.textContent = "+ Eintrag";
    addBtn.onclick = () => addEntry(event);
    addBtn.disabled = event.status === 'terminated';
    addRow.appendChild(addBtn);
    card.appendChild(addRow);

    // Count section
    const countSec = document.createElement('div');
    countSec.className = 'section';
    const countTitle = document.createElement('div');
    countTitle.className = 'muted';
    countTitle.textContent = "Zählen";
    countSec.appendChild(countTitle);

    const btnWrap = document.createElement('div');
    btnWrap.className = 'count-buttons';
    event.entries.forEach((entry, i) => {
      const b = document.createElement('button');
      b.textContent = `${entry.label} (${entry.count})`;
      if (event.status === 'running') {
        b.onclick = ()=>{ event.entries[i].count++; save(); };
      } else {
        b.disabled = true;
      }
      btnWrap.appendChild(b);
    });
    countSec.appendChild(btnWrap);
    card.appendChild(countSec);

    eventsDiv.appendChild(card);
  });
}

// ====== Trash UI ======
function toggleTrash(){
  const t = document.getElementById('trash');
  t.style.display = (t.style.display==='none' || !t.style.display) ? 'block' : 'none';
  if (t.style.display === 'block') renderTrash();
}

function renderTrash(){
  const evDiv = document.getElementById('trash-events');
  const enDiv = document.getElementById('trash-entries');
  if (!evDiv || !enDiv) return;

  evDiv.innerHTML = '<h3>Events</h3>' + (trash.events.length ? '' : '<p class="muted">Keine gelöschten Events.</p>');
  trash.events.forEach((e, i) => {
    const wrap = document.createElement('div');
    wrap.innerHTML = `<strong>${e.name}</strong> <small class="muted">(ID: ${e.id})</small>`;
    const restore = document.createElement('button'); restore.className='btn'; restore.textContent = 'Wiederherstellen';
    restore.onclick = () => { events.push(e); trash.events.splice(i,1); save(); renderTrash(); updateTrashCount(); };
    const purge = document.createElement('button'); purge.className='btn-danger'; purge.textContent = 'Endgültig löschen';
    purge.onclick = () => { trash.events.splice(i,1); renderTrash(); updateTrashCount(); };
    wrap.append(' ', restore, ' ', purge);
    evDiv.appendChild(wrap);
  });

  enDiv.innerHTML = '<h3>Einträge</h3>' + (trash.entries.length ? '' : '<p class="muted">Keine gelöschten Einträge.</p>');
  trash.entries.forEach((en, i) => {
    const wrap = document.createElement('div');
    wrap.innerHTML = `<strong>${en.label}</strong> <small class="muted">(Event: ${en.parentName ?? en.parentId})</small>`;
    const restore = document.createElement('button'); restore.className='btn'; restore.textContent = 'Wiederherstellen';
    restore.onclick = () => {
      const parent = events.find(ev => ev.id === en.parentId);
      if (!parent) { alert('Event für diesen Eintrag existiert nicht (mehr).'); return; }
      parent.entries.push({ id: en.id || crypto.randomUUID(), label: en.label, count: en.count || 0 });
      trash.entries.splice(i,1); save(); renderTrash(); updateTrashCount();
    };
    const purge = document.createElement('button'); purge.className='btn-danger'; purge.textContent = 'Endgültig löschen';
    purge.onclick = () => { trash.entries.splice(i,1); renderTrash(); updateTrashCount(); };
    wrap.append(' ', restore, ' ', purge);
    enDiv.appendChild(wrap);
  });

  updateTrashCount();
}

function emptyTrash(){
  if (confirm('Papierkorb wirklich endgültig leeren?')){
    trash.events = []; trash.entries = [];
    renderTrash(); updateTrashCount();
  }
}

function updateTrashCount(){
  const span = document.getElementById('trash-count');
  if (span) span.textContent = (trash.events.length + trash.entries.length);
}

// ====== Init ======
render();
renderTrash();
updateTrashCount();
</script>
</body>
</html>
